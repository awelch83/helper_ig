$(()=>{"use strict";let e;const t=[];let o="",l=!1;const s={statusDiv:document.getElementById("status"),follows:$("#follows"),followed_by:$("#followed_by"),detailedinfo:$("#detailedinfo"),detInfoCheckbox:$("#detInfoCheckbox")};chrome.runtime.onMessage.addListener(o=>{if("get_insta_users"===o.action){const n=instaDefOptions.you===o.userName?instaUserInfo.getUserProfile({username:o.viewerUserName}):o.userName;Promise.all([n]).then(n=>{"object"==typeof n[0]&&(o.userName=o.viewerUserName,o.user_is_private=n[0].is_private,o.follows_count=n[0].follows_count,o.followed_by_count=n[0].followed_by_count,o.userId=n[0].id,o.user_followed_by_viewer=!1),function(o){const n={request:null,userName:o.userName,pageSize:o.pageSize,delay:o.delay,followDelay:o.followDelay,csrfToken:o.csrfToken,userId:o.userId,requestRelType:o.relType,relType:"All"===o.relType?o.follows_count>o.followed_by_count?"follows":"followed_by":o.relType,callBoth:"All"===o.relType,checkDuplicates:t.length>0,limit:o.limit,follows_count:o.follows_count,followed_by_count:o.followed_by_count,follows_processed:0,followed_by_processed:0,startTime:new Date,timerInterval:(d=document.querySelector("#timer"),u=new Date,setInterval(()=>{const e=parseInt(new Date-u);let t=e/1e3;const o=parseInt(t%60,10);t/=60;const l=parseInt(t%60,10);t/=60;const s=parseInt(t%24,10);d.textContent=`${s}h:${"00".substring(0,2-`${l}`.length)+l}m:${"00".substring(0,2-`${o}`.length)+o}s`},1e3)),receivedResponses:0,processedUsers:0,followProcessedUsers:0,followedUsers:0,requestedUsers:0,viewerUserId:o.viewerUserId};var d,u;f=n,function(e){const t=e.limit>0&&e.limit<e.followed_by_count?e.limit:e.followed_by_count,o=e.limit>0&&e.limit<e.followed_by_count;(e.callBoth||"followed_by"===e.relType)&&(document.getElementById("followed_by_title").textContent=`${e.userName} is followed by ${e.followed_by_count} users`,o&&(document.getElementById("followed_by_title").textContent+=`; you set the return limit, therefore the collection will be stopped when ${t}+ returned`),document.getElementById("followed_by_title").style.display="block",s.followed_by.show().asProgress({namespace:"progress",min:0,max:t,goal:t,easing:"linear",labelCallback(o){const l=this.getPercentage(o);return`Followed by:${e.followed_by_processed}/${t}/${l}%`}}))}(f),function(e){const t=e.limit>0&&e.limit<e.follows_count?e.limit:e.follows_count,o=e.limit>0&&e.limit<e.follows_count;(e.callBoth||"follows"===e.relType)&&(document.getElementById("follows_title").textContent=`${e.userName} follows ${e.follows_count} users`,o&&(document.getElementById("follows_title").textContent+=`; you set the return limit, therefore the collection will be stopped when ${t}+ returned`),document.getElementById("follows_title").style.display="block",s.follows.show().asProgress({namespace:"progress",min:0,max:t,goal:t,easing:"linear",labelCallback(o){const l=this.getPercentage(o);return`Follows:${e.follows_processed}/${t}/${l}%`}}))}(f),s.detInfoCheckbox.show(),function(e){return new Promise(o=>{const l=new FetchUsers(Object.assign({},{obj:e,myData:t,htmlElements:s,updateStatusDiv:r,resolve:o}));l.fetchInstaUsers()})}(n).then(o=>{c(o,a),function(o){$("#exportDiv").show(),$("#export_XLSX").on("click",()=>{let l="xlsx";const s=document.getElementsByName("outType");for(let e=0;e<s.length;e+=1)if(s[e].checked){l=s[e].value;break}const r=`${o.requestRelType}_users_${o.userName}${o.limit>0?`_limit_${o.limit}`:""}_${exportUtils.formatDate(new Date)}.${l}`;let n=[];e?(console.log("Have filtered list",e.length),n=e):(console.log("DO NOT have filtered list",t.length),n=t),function(e,t,o){const l=exportUtils.h1,s=o.map(e=>{const t=Object.keys(e),o={};for(let s=0;s<t.length;s+=1)l.includes(t[s])&&(o[t[s]]=e[t[s]]);return o});if("xlsx"===e){const o=XLSX.utils.book_new();o.Props={Title:"Users Title",Subject:"Users Subject",Author:"Instagram Helper",CreatedDate:new Date},o.SheetNames.push("UsersSheet");const r=XLSX.utils.json_to_sheet(s,{header:l,cellDates:!0}),n=XLSX.utils.decode_range(r["!ref"]).e.r+1;for(let e=2;e<=n;e+=1)XLSX.utils.cell_set_hyperlink(r[`D${e}`],r[`D${e}`].v,r[`D${e}`].v);o.Sheets.UsersSheet=r;const a=XLSX.write(o,{bookType:e,type:"binary"});saveAs(new Blob([exportUtils.s2ab(a)],{type:"application/octet-stream"}),t)}else{const e=XLSX.utils.book_new(),o=XLSX.utils.json_to_sheet(s,{header:l});XLSX.utils.book_append_sheet(e,o,"output"),XLSX.writeFile(e,t)}}(l,r,n)}),$("#massFollow").on("click",()=>{if(confirm("It will follow ALL not-followed/not-requested ousers DISPLAYED in the table below (it means filtering in table is respected)."+`\nFollowing will be done with the interval of ${o.followDelay/1e3}sec.`+"\nYou can change the interval value in the settings\nWhen process is started, the change of filter criteria in the table is ignored.\nContinue?")){let l=[];e?(console.log("Have filtered list",e.length),l=e):(console.log("DO NOT have filtered list",t.length),l=t),function(e,t){return new Promise((o,l)=>{e.followProcessedUsers=0,e.followedUsers=0,e.requestedUsers=0,function e(t,o,l,s){if(t.followProcessedUsers>=o.length)return void l();r(`Mass following users: ${t.followProcessedUsers+1} of ${o.length}`);if(null===o[t.followProcessedUsers].followed_by_viewer||o[t.followProcessedUsers].followed_by_viewer)t.followProcessedUsers+=1,e(t,o,l,s);else if(o[t.followProcessedUsers].id===t.viewerUserId)t.followProcessedUsers+=1,e(t,o,l,s);else{const n=o[t.followProcessedUsers].username,a=o[t.followProcessedUsers].id;console.log(`${n} is not followed yet.`),r(`${n} is not followed yet:\n          processed ${t.followProcessedUsers+1} of ${o.length}/\n          followed - ${t.followedUsers}/requested - ${t.requestedUsers}`),followUser.follow({username:n,userId:a,csrfToken:t.csrfToken,updateStatusDiv:r}).then(a=>{t.followProcessedUsers+=1,t.receivedResponses+=1,"following"===a?t.followedUsers+=1:"requested"===a?t.requestedUsers+=1:console.log(`Not recognized result - ${a}`),r(`The request to follow ${n} was successful -\n              ${a}/processed ${t.followProcessedUsers} of ${o.length}/\n              followed - ${t.followedUsers}/requested - ${t.requestedUsers}`),setTimeout(()=>{e(t,o,l,s)},t.followDelay)})}}(e,t,o,l)})}(o,l).then(()=>{r(`Completed: ${o.followProcessedUsers}\n              processed/${o.followedUsers}\n              followed/${o.requestedUsers} requested`)})}}),$("#massUnFollow").on("click",()=>{$("#unfollowDiv").show(),$("#startMassUnFollow").on("click",()=>{if((""!==$("#keepUsers").val().trim()||confirm("You have not specified the users to be kept. Continue?"))&&confirm("It will unfollow ALL USERS displayed in the table below except the users whose id you specified in the textarea."+`\nUnFollowing will be done with the interval of ${o.followDelay/1e3}sec.`+"\nWhen process is started, the changes of filter criteria in the table or/and the list of users to be kept are ignored.\nContinue?")){o.keepUsers=$("#keepUsers").val().replace(/[\n\r]/g,",").split(","),o.keepUsers.push(o.viewerUserId);let l=[];e?(console.log("Have a filtered list",e.length),l=e):(console.log("DO NOT have a filtered list",t.length),l=t),function(e,t){return new Promise((o,l)=>{e.unFollowProcessedUsers=0,e.unFollowedUsers=0,function e(t,o,l,s){if(t.unFollowProcessedUsers>=o.length)return void l();r(`Mass unFollowing users: ${t.unFollowProcessedUsers+1} of ${o.length}`);const n=o[t.unFollowProcessedUsers].username;const a=o[t.unFollowProcessedUsers].id;t.keepUsers.includes(a)?(console.log(`>>>>>>>>>>>>>>>${n} is followed and it will NOT be unfollowed.`),t.unFollowProcessedUsers+=1,e(t,o,l,s)):(console.log(`${n}/${a} will be unfollowed.`),r(`${n}/${a} will be unfollowed:\n            processed ${t.unFollowProcessedUsers+1} of ${o.length}/\n            followed - ${t.unFollowedUsers}`),followUser.unFollow({username:n,userId:a,csrfToken:t.csrfToken,updateStatusDiv:r}).then(a=>{t.unFollowProcessedUsers+=1,t.receivedResponses+=1,t.unFollowedUsers+=1,r(`The request to unfollow ${n} was successful -\n                processed ${t.unFollowProcessedUsers} of ${o.length}/unfollowed - ${t.unFollowedUsers}`),setTimeout(()=>{e(t,o,l,s)},t.followDelay)}))}(e,t,o,l)})}(o,l).then(()=>{r(`Completed: ${o.unFollowProcessedUsers}\n              processed/${o.unFollowedUsers}`)})}})})}(o),$("#startDetailedInfoCollection").is(":checked")?($("#details").show(),$("#cancelDetInfo").on("click",()=>l=confirm("Do you want to cancel?")),function(e,t){r(`Found users ${t.length}`),document.getElementById("detailedinfo_title").textContent="Getting the detailed info",s.detailedinfo.asProgress({namespace:"progress",min:0,max:t.length,goal:t.length,easing:"linear",labelCallback(o){const l=this.getPercentage(o);return`Users: ${e.processedUsers}/${t.length}/${l}%`}})}(o,t),function(e,o){return new Promise((n,a)=>{!function e(o,n,a,i){instaUserInfo.getUserProfile({username:n[o.processedUsers].username,userId:n[o.processedUsers].id,updateStatusDiv:r}).then(c=>{t[o.processedUsers]=$.extend({},t[o.processedUsers],c),o.receivedResponses+=1,s.detailedinfo.asProgress("go",o.processedUsers+=1),r(`Getting detailed info for users: ${o.processedUsers} of ${n.length}`),o.processedUsers!==n.length?l?i():setTimeout(()=>{e(o,n,a,i)},0):a()})}(e,o,n,a)})}(o,t).then(()=>{i(o,!0)}).catch(()=>{i(o,!1)})):i(o,!1),s.detInfoCheckbox.remove()});var f}(o)})}});const r=function(e,t){s.statusDiv.textContent=e,s.statusDiv.style.color=t||"black"},n=[{label:"User",name:"profile_pic_url_hd",width:"320",align:"center",sortable:!1,formatter:(e,t,o)=>`<a href='https://www.instagram.com/${o.username}' target='_blank'><img src='${e}' alt='' /></a>`,search:!1},{label:"User Id",name:"id",width:"80",align:"center",search:!0,searchoptions:{sopt:["bw","cn"]}},{label:"Info",name:"username",sortable:!1,formatter(e,t,o){let l=`username:<strong>${o.username}</strong><br/>`;return l+=o.full_name?`full name:<strong>${o.full_name}</strong><br/>`:"",l+=o.connected_fb_page?`FB:<a href='${o.connected_fb_page}' target='_blank'>${o.connected_fb_page}</a><br/>`:"",l+=o.external_url?`url:<a href='${o.external_url}' target='_blank'>${o.external_url}</a>`:""},cellattr:()=>'style="white-space: normal;"',search:!0,stype:"text",searchoptions:{dataInit(e){$(e).attr("placeholder","<<Filter by username>>")}}},{label:"Bio",name:"biography",sortable:!1,formatter:e=>e||"",cellattr:()=>'style="white-space: normal;"',search:!1},{label:"Follows <br/>you",name:"follows_viewer",width:"80",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No;null:Requested you"},formatter(e,t,o){const l=o.has_requested_viewer?"ui-state-disabled":"";return`<input type='checkbox'\n        ${o.follows_viewer||o.has_requested_viewer?'checked="checked"':""}\n        class='${l}' value='${o.follows_viewer}' offval='no' disabled='disabled'>`},cellattr:()=>'style="background-color: #fbf9ee;" title="Follows you"',search:!0},{label:"Followed <br>by you",name:"followed_by_viewer",width:"80",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No;null:Requested by you"},formatter(e,t,o){const l=o.requested_by_viewer?"ui-state-disabled":"";return`<input type='checkbox'\n        ${o.followed_by_viewer||o.requested_by_viewer?'checked="checked"':""}\n        class='${l}' value='${o.followed_by_viewer}' offval='no' disabled='disabled'>`},cellattr:()=>'style="background-color: #fbf9ee;" title="Followed by you"',search:!0},{delete:"follows",label:"Follows <br/>user",name:"user_followed_by",width:"80",formatter:"checkbox",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No"},cellattr:()=>`title="Follows ${o}"`,search:!0},{delete:"followed_by",label:"Followed <br/>by user",name:"user_follows",width:"80",formatter:"checkbox",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No"},cellattr:()=>`title="Followed by ${o}"`,search:!0},{label:"Private",name:"is_private",width:"80",formatter:"checkbox",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No"},cellattr:()=>'title="Is private"',search:!0},{label:"Followers",name:"followed_by_count",width:"70",align:"center",sorttype:"number",search:!0,searchoptions:{sopt:["ge","le","eq"]},cellattr:()=>'title="Followers"'},{label:"Following",name:"follows_count",width:"70",align:"center",sorttype:"number",search:!0,searchoptions:{sopt:["ge","le","eq"]},cellattr:()=>'title="Following"'},{label:"Posts",name:"media_count",width:"70",align:"center",sorttype:"number",search:!0,searchoptions:{sopt:["ge","le","eq"]},cellattr:()=>'title="Posts"'},{label:"Date of latest post",name:"latestPostDate",width:"70",align:"center",formatter:"date",sorttype:"date",search:!0,searchoptions:{sopt:["ge","le"],dataInit(e){const t=this;$(e).datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,showButtonPanel:!0,showOn:"focus",onSelect(){"gs_"===this.id.substr(0,3)?setTimeout(()=>{t.triggerToolbar()},50):$(this).trigger("change")}})}},cellattr:()=>'title="The date of the latest post (cannot be displayed for private accounts you don\'t follow)\r\n\r\nDate format is MM/DD/YYYY"'}],a=[{label:"User",name:"profile_pic_url",align:"center",sortable:!1,formatter:(e,t,o)=>`<a href='https://www.instagram.com/${o.username}' target='_blank'><img src='${e}' alt='' /></a>`,search:!1},{label:"User Id",name:"id",width:"80",align:"center",search:!0,searchoptions:{sopt:["bw","cn"]}},{label:"Info",name:"username",sortable:!1,formatter(e,t,o){let l=`username:<strong>${o.username}</strong><br/>`;return l+=o.full_name?`full name:<strong>${o.full_name}</strong><br/>`:""},cellattr:()=>'style="white-space: normal;"',search:!0,stype:"text",searchoptions:{dataInit(e){$(e).attr("placeholder","<<Filter by username>>")}}},{label:"Followed <br>by you",name:"followed_by_viewer",width:"80",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No;null:Requested by you"},formatter(e,t,o){const l=o.requested_by_viewer?"ui-state-disabled":"";return`<input type='checkbox'\n        ${o.followed_by_viewer||o.requested_by_viewer?'checked="checked"':""}\n        class='${l}' value='${o.followed_by_viewer}' offval='no' disabled='disabled'>`},cellattr:()=>'style="background-color: #fbf9ee;" title="Followed by you"',search:!0},{delete:"follows",label:"Follows <br/>user",name:"user_followed_by",width:"80",formatter:"checkbox",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No"},cellattr:()=>`title="Follows ${o}"`,search:!0},{delete:"followed_by",label:"Followed <br/>by user",name:"user_follows",width:"80",formatter:"checkbox",align:"center",stype:"select",searchoptions:{sopt:["eq"],value:":Any;true:Yes;false:No"},cellattr:()=>`title="Followed by ${o}"`,search:!0}];function i(e,o){clearInterval(e.timerInterval);const l=document.querySelector("#timer");s.detailedinfo.asProgress("finish").asProgress("stop"),document.getElementById("cancelDetInfo").remove();let a="",i="";e.followed_by_count!==e.followed_by_processed&&(a=`(actually returned ${e.followed_by_processed})`),e.follows_count!==e.follows_processed&&(i=`(actually returned ${e.follows_processed})`),r(`Completed${e.limit>0?` with limit ${e.limit}`:""}${o?"":", detailed info collection was cancelled"},\n      spent time - ${l.textContent},\n      created list length - ${t.length} (follows - ${e.follows_count}${i},\n      followed by - ${e.followed_by_count}${a}),\n      sent HTTP requests - ${e.receivedResponses}`),o&&($(".ui-jqgrid").replaceWith('<table id="jqGrid"></table><div id="jqGridPager"></div>'),c(e,n)),setTimeout(()=>{document.getElementById("tempUiElements").remove(),document.getElementById("details").remove()},3e3)}function c(l,s){if(o=l.userName,"All"!==l.requestRelType)for(let e=0;e<s.length;e+=1)if(s[e].delete===l.requestRelType){s.splice(e,1);break}$("#jqGrid").jqGrid({pager:"#jqGridPager",datatype:"local",data:t,rowNum:instaDefOptions.gridPageSize,autowidth:!0,height:"100%",rownumbers:!0,colModel:s,viewrecords:!0,loadonce:!0,ignoreCase:!0,caption:"All"===l.requestRelType?`${l.requestRelType} users of ${l.userName}`:`${l.userName} ${l.requestRelType}`}).jqGrid("filterToolbar",{searchOperators:!0,defaultSearch:"cn",searchOnEnter:!1}).jqGrid("navGrid","#jqGridPager",{search:!0,add:!1,edit:!1,del:!1,refresh:!0},{},{},{},{multipleSearch:!0,closeAfterSearch:!0,closeOnEscape:!0,searchOnEnter:!0,showQuery:!0},{}).jqGrid("setGridWidth",$("#jqGrid").width()-20);const r=$.jgrid.from;$.jgrid.from=function(t,o){const l=r.call(this,t,o),s=l.select;return l.select=function(t){return e=s.call(this,t)},l}}}),window.onload=function(){_gaq.push(["_trackPageview"])};